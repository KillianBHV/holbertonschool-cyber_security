require 'msf/core'

module Msf
	module Auxiliary
		class CustomPortScanner < Msf::Auxiliary
			include Msf::Auxiliary::Scanner

			def initialize
				super(
                                        'Name' => 'Scans a range of ports on a target system',
					'Author' => ['KillianBHV'],
					'License' => MSF_LICENSE
					)

				register_options(
				[
					Opt::RHOST(),
					OptInt.new('STARTPORT', [true, 'Starting port', 20]),
					OptInt.new('ENDPORT', [true, 'Ending port', 10000])
					]
				)
				end

			def run_host(ip)
				start_port = datastore['STARTPORT']
				end_port = datastore['ENDPORT']

				if start_port > end_port
					print_error("STARTPORT cannot be greater than ENDPORT")
					return
				end

				print_status("Scanning ports from #{start_port} to #{end_port} in #{ip}...")

				open_ports = []

				(start_port..end_port).each do |port|
				begin
					sock = connect(nil, ip, port, 1)
					if sock
						print_good("#{ip}:#{port} - The port #{port} is open")
						open_ports << port
					end
				rescue Rex::ConnectionError
				    ensure
					    disconnect(sock) if sock
				    end
				end
							
				if open_ports.empty?
					print_status("No open port detected in #{ip}.")
				else
					print_status("Open ports in #{ip}: #{open_ports.join(', ')}")
				end
			end
		end
	end
end
