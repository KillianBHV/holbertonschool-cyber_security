require 'msf/core'

module Msf
	module Auxiliary
		class MS17010Checker < Msf::Auxiliary
			include Msf::Auxiliary::Scanner

			def initialize
				super(
					'Name' => 'MS17-010 Vulnerability Checker',
					'Description' => 'Checks if a target system is vulnerable to MS17-010 (EternalBlue).',
					'Author' => ['KillianBHV'],
					'License' => MSF_LICENSE
				)

				# Opciones del módulo
				register_options(
					[
						Opt::RHOST()
					]
				)
			end

			def run_host(ip)
				print_status("Verifying #{ip} for MS17-010  vulnerability...")

				begin
					# Conexión al puerto SMB (445)
					sock = connect(nil, ip, 445, 5)

					smb_packet = "\x00\x00\x00\x90" + "\xFF\x53\x4D\x42" + ("\x00" * 100)
					sock.put(smb_packet)
					response = sock.get_once

					if response && response.include?("\x05\x02\x00\xC0")
						print_good("#{ip} is vulnerable a MS17-010.")
					else
						print_status("#{ip} is not vulnerable a MS17-010.")
					end
				rescue Rex::ConnectionError
					print_error("No connected SMB port detected in #{ip}.")
				ensure
					disconnect(sock) if sock
				end
			end
		end
	end
end
